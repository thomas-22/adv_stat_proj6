---
title: "Report"
author: "Group"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r source_all, echo=FALSE}
source("source_all.R")
```


```{r read data}
Pregnancy <- prep.Pregnancy.data()
Movement <- prep.Movement.data()
HuntEvents <- prep.HuntEvents.data()
FCMStress <- prep.FCMStress.data()

# # save as RDS
# saveRDS(Pregnancy, "Data/intermediate/Pregnancy.RDS")
# saveRDS(Movement, "Data/intermediate/Movement.RDS")
# saveRDS(HuntEvents, "Data/intermediate/HuntEvents.RDS")
# saveRDS(FCMStress, "Data/intermediate/FCMStress.RDS")
```

```{r augment data}
Groups <- get.Herds(Movement, enclosures)
Stress <- CalcSenderPosDist(Movement, HuntEvents)
# # save as RDS
# saveRDS(Groups, "Data/intermediate/Groups.RDS")
# saveRDS(Stress, "Data/intermediate/Stress.RDS")
```


```{r finalize data}
data.intermediate <- Datafusion(Movement, Pregnancy, Stress, Groups, timediff = 2*60)
data.full <- Assign_FCMData(FCMStress,
                            data.intermediate,
                            gut.retention.threshold = c(5, 35),
                            distance.threshold = 10000,
                            ignore.filters = FALSE)

model.data <- data.full %>% select(Sender.ID, Distance, pregnant, group, TimeDiff, ng_g) %>%
  mutate(TimeDiff = scale(as.numeric(TimeDiff), center = FALSE)[,1],
         Distance = scale(Distance, center = FALSE)[,1])
```

```{r visualize data}
head(model.data)

model.data %>%
  ggplot()+
  geom_bar(aes(x = forcats::fct_reorder(Sender.ID, as.numeric(group)), fill = group)) +
  guides(x = guide_axis(angle = 60)) +   
  labs(y="observations", x="Deer", title = "Number of observations per deer and herd") 

model.data %>%
  ggplot() +
  geom_mosaic(aes(x = product(group, pregnant), fill = group)) +   
  labs(y="Herd", x="Pregnant?", title = "Herds and pregnant deer in the model data") +
  guides(fill = "none")
```



```{r initial modelling}
simple.model <- lm(ng_g ~., data = model.data)
summary(simple.model)

mod <- lm(ng_g ~ TimeDiff * I(1/Distance), data = model.data)
summary(mod)

random.intercept.model <- lmer(ng_g ~ TimeDiff + Distance + (1 | group/Sender.ID) + (1 | pregnant), data = model.data)

random.slope.model <- lmer(ng_g ~ (TimeDiff + Distance | Sender.ID) + 
                             #(TimeDiff + Distance | pregnant) +
                             (1 | pregnant), 
                           data = model.data)
```


```{r diagnosis of initial modelling}
model.data.augmented <- model.data %>%
  mutate(simple.model = predict(simple.model, model.data),
         even.simpler.model = predict(mod, model.data),
         random.intercept.model = predict(random.intercept.model, model.data),
         random.slope.model = predict(random.slope.model, model.data),
         Sample_ID = data.full$Sample_ID) %>%
  pivot_longer(c(even.simpler.model, simple.model, random.intercept.model, random.slope.model),
               values_to = ".fit",
               names_to = "model") %>%
  mutate(.resid = ng_g - .fit)

RMSEs <- model.data.augmented %>%
  group_by(model) %>%
  summarise(RMSE = sqrt(mean(.resid^2)))

ggplot(model.data.augmented, aes(color = model)) +
  stat_qq_line(aes(sample = .resid), color = "black") + 
  stat_qq(aes(sample = .resid), alpha = .7, size = 1) + 
  theme_light() +
  labs(y = "Residuals", x = "theoretical Quantiles", title = "QQ-Plots of different model fits") +
  ggrepel::geom_label_repel(data = RMSEs, aes(label = sprintf("RMSE: %.2f", RMSE), x = 2, y = -150), direction = "y", force = .5) 

ggplot(model.data.augmented, aes(color = model)) +
  geom_point(aes(x = .fit, y = .resid)) +
  geom_hline(yintercept = 0, color = "black") +
  labs(y = "Residuals",x = "fitted values", title = "Residuals vs fitted values") +
  facet_wrap(~model, nrow = 3) +
  guides(color = "none")


ggplot(model.data.augmented, aes(color = model)) +
  geom_point(aes(x = ng_g, y = .fit), alpha = .5, size = 1) +
  geom_smooth(aes(x = ng_g, y = .fit), method = "lm", se = FALSE) +
  geom_abline(slope = 1) +
  labs(x = "actual", y = "predicted")
```

